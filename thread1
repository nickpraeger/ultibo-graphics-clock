unit Thread1;

{$mode objfpc}{$H+}

interface
uses
    RaspberryPi,
    GlobalConfig,
    GlobalConst,
    GlobalTypes,
    Platform,
    Threads,
    SysUtils,
    Classes,
    Ultibo,       {The Ultibo unit provides some APIs for getting and setting timezones}
    Console,
    GraphicsConsole,
    freetypeh,
    Devices,
    I2C,
    DS1307,       {This unit allows configuration and use of the RTC}
    RTC,          {useful RTC functions}
    Keyboard,     {Keyboard uses USB so that will be included automatically}
    DWCOTG,       {We need to include the USB host driver for the Raspberry Pi}
    Timezone,
    DateUtils;
var
s:string;


function Thread1Execute(Parameter:Pointer):PtrInt;

implementation

function Thread1Execute(Parameter:Pointer):PtrInt;


const

RightNow:int64 = 131916290000000000;   //  2019/01/10 21:23:20 GMT
OneYear:int64 =3652425*24*60*60*1000;
OneMonth:int64 =30*24*60*60*10000000;
OneDay:int64 =24*60*60*10000000;
OneHour:int64 =60*60*10000000;
OneMin:int64 =60*10000000;
OneSec:int64 =10000000;



var
Console1:TWindowHandle;
Character:Char = #0;  {keyboard presses}
newDateTime: int64 =0; {for changing RTC time}
adjustment: int64 =0; //for adjusting date time
adjYear: int64 =0;
adjMonth: int64 =0;
adjDay: int64 =0;
adjHour: int64 =0;
adjMin: int64 =0;
adjSec: int64 =0;

procedure Log (message : string);
begin
   ConsoleWindowWriteLn (Console1, message);
   s:=message;
end;

begin
  Thread1Execute:=0;

//   Console1:=ConsoleWindowCreate(ConsoleDeviceGetDefault,CONSOLE_POSITION_BOTTOM,False);

   ThreadSetName(GetCurrentThreadId,'Example Thread1');
 {see if the RTC is available}

 while RTCAvailable = FALSE do
      begin
        Log('RTC Not Available' + DateTimeToStr(Now));
        RightNow:=RightNow + OneSec;
       threadsleep(1000);
      end;

 if RTCAvailable then
     begin
     Log('RTC Available' + DateTimeToStr(Now));
     if (RTCGetTime < RightNow) then
         begin
     Log('RTC Updated');
     RtcSetTime(RightNow);
     Log(DateTimeToStr(Now));
     Log(' ');
     end;
     Log(' ');
    end;

  while True do
  begin

   {Read a character from the global keyboard buffer. If multiple keyboards are connected all characters will end up in a single buffer and be received here}
   if ConsoleGetKey(Character,nil) then
   begin
   newDateTime:= 0;
   case Character of
        #0:  begin     {if shift is held for increasing values, read second character}
                  ConsoleGetKey(Character,nil);
                  end;
        'Y':  begin
                  Log('Y pressed, Increase year by 1');
                  adjYear:= adjYear+1;
                  end;
        'N': begin
                  Log('N pressed, Increase month by 1');
                  adjMonth:= adjMonth+1;
                  end;
        'D': begin
                  Log('D pressed, Increase day by 1');
                  adjDay:=adjDay+1;
                  end;
        'H': begin
                  Log('H pressed, Increase hour by 1');
                  adjHour:=adjHour+1;
                  end;
        'M': begin
                  Log('M pressed, Increase minute by 1');
                  adjMin:=adjMin+1;
                  end;
        'S': begin
                  Log('S pressed, Increase second by 1');
                  adjSec:=adjSec+1;
                  end;
        'y': begin
                  Log('y pressed, Decrease year by 1');
                  adjYear:= adjYear-1;
                  end;
      'n': begin
                  Log('n pressed, Decrease month by 1');
                  adjMonth:=adjMonth-1;
                  end;
      'd':  begin
                  Log('d pressed, Decrease day by 1');
                  adjDay:=adjDay-1;
                  end;
      'h': begin
                  Log('h pressed, Decrease hour by 1');
                  adjHour:=adjHour-1;
                  end;
      'm': begin
                  Log('m pressed, Decrease minute by 1');
                  adjMin:=adjMin-1;
                  end;
      's': begin
                  Log('s pressed, Decrease second by 1');
                  adjSec:=adjSec-1;
                  end;
      #13: begin
                  adjustment:=adjYear*OneYear+adjMonth*OneMonth+adjDay*OneDay+adjHour*OneHour+adjMin*OneMin+adjSec*OneSec;
                  Log('Enter to reboot and change time by (y/m/d h:m:s): ' + IntToStr(adjYear) + '/' + IntToStr(adjMonth) + '/' + IntToStr(adjDay) + ' ' + IntToStr(adjHour) + ':' + IntToStr(adjMin) + ':' + IntToStr(adjSec));
                  if ConsoleGetKey(Character,nil) then
                  begin
                     if Character = #13  then begin
                        newDateTime:= SysRtcGetTime+adjustment;
                        RTCSetTime(newDateTime);
                        Log('Rebooting...');
                        SystemRestart(1000)//reboot
                        end
                     else begin
                          Log('Adjustments cleared');
                          adjustment:=0;
                          adjYear:=0;
                          adjMonth:=0;
                          adjDay:=0;
                          adjHour:=0;
                          adjMin:=0;
                          adjSec:=0;
                          sleep(500);
                          Log('');
                          end;
                         end;
                     end;
     end;    {end of  case statement}

   end;      {end of if button pressed statement}

   end;    {end of loop}

    end;
   end.
